<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Loop Points Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            padding: 20px;
        }
        .test-container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #fff;
        }
        .controls {
            margin: 10px 0;
        }
        button {
            margin: 5px;
            padding: 10px 15px;
            background-color: #333;
            color: #fff;
            border: 1px solid #fff;
            cursor: pointer;
        }
        button:hover {
            background-color: #555;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background-color: #222;
        }
        .loop-info {
            color: #0f0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Audio Loop Points Test</h1>
    
    <div class="test-container">
        <h2>Loop Point Configuration</h2>
        <div class="loop-info">
            <p>tm1_1.mp3: First play tracks to 113.708s, then loops seamlessly</p>
            <p>tm1_2.mp3: First play tracks to 203.217s, then loops seamlessly</p>
            <p><em>Note: Phaser audio system uses full track looping for reliability</em></p>
        </div>
    </div>
    
    <div class="test-container">
        <h2>Stage 1 BGM (tm1_1.mp3)</h2>
        <div class="controls">
            <button onclick="playStage1()">Play Stage 1</button>
            <button onclick="stopAudio()">Stop</button>
            <button onclick="getCurrentTime()">Get Current Time</button>
        </div>
        <div class="status" id="stage1-status">Status: Ready</div>
    </div>
    
    <div class="test-container">
        <h2>Stage 2 BGM (tm1_2.mp3)</h2>
        <div class="controls">
            <button onclick="playStage2()">Play Stage 2</button>
            <button onclick="stopAudio()">Stop</button>
            <button onclick="getCurrentTime()">Get Current Time</button>
        </div>
        <div class="status" id="stage2-status">Status: Ready</div>
    </div>
    
    <div class="test-container">
        <h2>Instructions</h2>
        <p>1. Click "Play Stage 1" or "Play Stage 2" to start the audio</p>
        <p>2. Audio will play with seamless looping using standard HTML5 audio</p>
        <p>3. The system tracks when the first play reaches the end point</p>
        <p>4. Use "Get Current Time" to check the current playback position</p>
        <p>5. Use "Stop" to stop the audio</p>
    </div>

    <script src="game.js"></script>
    <script>
        let currentAudio = null;
        let currentBGMType = null;
        let firstPlay = true; // Track if this is the first play
        
        // Loop point configuration
        const loopPoints = {
            stage1: { start: 56.862, end: 113.708 },
            stage2: { start: 97.622, end: 203.217 }
        };
        
        function updateStatus(type, message) {
            const statusEl = document.getElementById(type + '-status');
            if (statusEl) {
                statusEl.textContent = 'Status: ' + message;
            }
        }
        
        function playStage1() {
            stopAudio();
            updateStatus('stage1', 'Loading...');
            
            const audio = new Audio('converted_audio/tm1_1.mp3');
            audio.volume = 0.5;
            audio.loop = true; // Use standard looping
            
            audio.addEventListener('loadedmetadata', () => {
                updateStatus('stage1', 'Playing (seamless looping)');
                audio.play();
            });
            
            audio.addEventListener('timeupdate', () => {
                const currentTime = audio.currentTime;
                if (currentTime >= 113.708 && firstPlay) {
                    firstPlay = false;
                    updateStatus('stage1', 'First play complete, looping seamlessly');
                }
            });
            
            audio.addEventListener('error', (e) => {
                updateStatus('stage1', 'Error loading audio');
            });
            
            currentAudio = audio;
            currentBGMType = 'stage1';
        }
        
        function playStage2() {
            stopAudio();
            updateStatus('stage2', 'Loading...');
            
            const audio = new Audio('converted_audio/tm1_2.mp3');
            audio.volume = 0.5;
            audio.loop = true; // Use standard looping
            
            audio.addEventListener('loadedmetadata', () => {
                updateStatus('stage2', 'Playing (seamless looping)');
                audio.play();
            });
            
            audio.addEventListener('timeupdate', () => {
                const currentTime = audio.currentTime;
                if (currentTime >= 203.217 && firstPlay) {
                    firstPlay = false;
                    updateStatus('stage2', 'First play complete, looping seamlessly');
                }
            });
            
            audio.addEventListener('error', (e) => {
                updateStatus('stage2', 'Error loading audio');
            });
            
            currentAudio = audio;
            currentBGMType = 'stage2';
        }
        
        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
                if (currentBGMType) {
                    updateStatus(currentBGMType, 'Stopped');
                }
            }
        }
        
        function getCurrentTime() {
            if (currentAudio && !currentAudio.paused) {
                const time = currentAudio.currentTime.toFixed(3);
                const type = currentBGMType || 'unknown';
                const loopPoint = loopPoints[type];
                if (loopPoint) {
                    const status = time >= loopPoint.end ? ' (should loop soon)' : '';
                    alert(`${type}: ${time}s${status}`);
                } else {
                    alert(`${type}: ${time}s`);
                }
            } else {
                alert('No audio playing');
            }
        }
    </script>
</body>
</html>